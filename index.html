<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LegalScraper | OPPORTIUM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--grafite:#2C2C2C;--off-white:#F5F5F5;--azul-petroleo:#006064;--azul-petroleo-light:#00838F;--laranja:#FF4010;--border:#E0E0E0;--border-light:#EEEEEE;--text-muted:#757575;--success:#2E7D32;--success-bg:#E8F5E9;--warning:#EF6C00;--warning-bg:#FFF3E0;--error:#C62828;--error-bg:#FFEBEE;--info-bg:#E0F2F1;--font-sans:'Inter',sans-serif;--font-mono:'JetBrains Mono',monospace}
body{font-family:var(--font-sans);background:var(--off-white);color:var(--grafite);line-height:1.5;-webkit-font-smoothing:antialiased}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* LOGIN */
.login-wrapper{height:100vh;display:flex;align-items:center;justify-content:center;background:var(--grafite);position:relative;overflow:hidden}
.login-bg{position:absolute;inset:0;background:radial-gradient(circle at 20% 50%,rgba(0,96,100,0.12) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,64,16,0.08) 0%,transparent 40%)}
.login-container{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:340px;padding:0 20px;animation:fadeUp .4s ease-out}
.login-brand{text-align:center;margin-bottom:24px}
.login-brand-name{font-size:10px;font-weight:100;letter-spacing:.3em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:4px}
.login-product{font-size:24px;font-weight:700;color:#fff}.login-product span{color:rgba(255,255,255,0.45)}
.login-card{width:100%;background:#fff;border-radius:12px;padding:28px 24px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.login-title{font-size:16px;font-weight:600;color:var(--grafite);margin-bottom:2px}
.login-subtitle{font-size:12px;color:var(--text-muted);margin-bottom:20px}
.field-group{margin-bottom:14px}
.field-group label{display:block;font-size:11px;font-weight:600;color:var(--grafite);margin-bottom:5px;text-transform:uppercase;letter-spacing:.02em}
.field-group input{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit;color:var(--grafite);outline:none;transition:border-color .15s}
.field-group input:focus{border-color:var(--azul-petroleo)}
.field-group input::placeholder{color:#aaa}
.password-wrap{position:relative}
.password-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:11px;font-weight:500}
.password-toggle:hover{color:var(--azul-petroleo)}
.captcha-box{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1.5px solid var(--border);border-radius:6px;margin-bottom:18px;cursor:pointer;background:var(--off-white);transition:all .15s}
.captcha-box:hover{border-color:#ccc}
.captcha-box.checked{border-color:var(--success);background:var(--success-bg)}
.captcha-checkbox{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;background:#fff;transition:all .15s}
.captcha-box.checked .captcha-checkbox{border-color:var(--success);background:var(--success)}
.captcha-label{font-size:12px;color:var(--grafite);flex:1}
.captcha-brand{font-size:9px;color:var(--text-muted);font-weight:600}
.login-btn{width:100%;padding:11px;background:var(--azul-petroleo);color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;transition:background .15s}
.login-btn:hover{background:var(--azul-petroleo-light)}
.login-btn:disabled{opacity:.7;cursor:not-allowed}
.login-btn .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
.login-error{background:var(--error-bg);color:var(--error);font-size:12px;font-weight:500;padding:10px 12px;border-radius:6px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.login-footer{margin-top:20px;text-align:center;font-size:10px;color:rgba(255,255,255,0.2)}
.watermark{position:fixed;bottom:12px;right:16px;font-size:9px;color:rgba(255,255,255,0.1);z-index:10}
.watermark-app{color:rgba(0,0,0,0.05)}

/* APP */
.app{display:none;min-height:100vh;background:var(--off-white)}
.app.active{display:flex}

/* SIDEBAR */
.sidebar{width:210px;min-width:210px;background:var(--grafite);color:#fff;display:flex;flex-direction:column;padding:18px 0;position:fixed;left:0;top:0;height:100vh;overflow-y:auto}

/* LOGO - ALINHADO √Ä ESQUERDA */
.logo{padding:2px 18px 20px;border-bottom:1px solid rgba(255,255,255,0.08)}
.logo-text{font-size:10px;font-weight:100;letter-spacing:.25em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:3px}
.logo-product{font-size:17px;font-weight:700;color:#fff}
.logo-product span{color:rgba(255,255,255,0.45)}

.menu-label{font-size:9px;font-weight:500;letter-spacing:.15em;text-transform:uppercase;color:rgba(255,255,255,0.25);padding:18px 18px 8px}
nav{flex:1;padding:0 8px;display:flex;flex-direction:column;gap:2px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:400;color:rgba(255,255,255,0.55);background:transparent;border:none;width:100%;text-align:left;font-family:inherit;border-left:3px solid transparent;transition:all .12s ease}
.nav-item svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.8;flex-shrink:0}
.nav-item:hover{color:rgba(255,255,255,0.9);background:rgba(255,255,255,0.05)}
.nav-item.active{background:rgba(0,96,100,0.15);color:#fff;border-left-color:var(--azul-petroleo);font-weight:500}
.nav-item.hidden{display:none}
.nav-badge{margin-left:auto;background:var(--laranja);color:#fff;font-size:9px;font-weight:700;border-radius:10px;padding:2px 7px;min-width:18px;text-align:center}
.sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,0.08);margin-top:auto}
.sidebar-user{display:flex;align-items:center;gap:10px}
.sidebar-avatar{width:32px;height:32px;border-radius:50%;background:var(--azul-petroleo);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#fff}
.sidebar-user-info{flex:1;min-width:0}
.sidebar-user-name{font-size:12px;font-weight:600;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sidebar-user-role{font-size:10px;color:rgba(255,255,255,0.4);margin-top:1px}
.sidebar-logout{background:none;border:none;color:rgba(255,255,255,0.35);cursor:pointer;padding:6px;border-radius:6px;display:flex;transition:all .12s}
.sidebar-logout:hover{color:rgba(255,255,255,0.9);background:rgba(255,255,255,0.08)}
.sidebar-logout svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.8}

/* MAIN */
.main{flex:1;margin-left:210px;padding:22px 28px;min-height:100vh}
.page{display:none;animation:fadeIn .2s ease;max-width:1100px}
.page.active{display:block}
.page-header{margin-bottom:20px}
.page-title{font-size:18px;font-weight:700;color:var(--grafite);margin-bottom:3px}
.page-subtitle{font-size:12px;color:var(--text-muted)}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px}
.stat-card{background:#fff;border-radius:10px;padding:18px 20px;box-shadow:0 1px 4px rgba(0,0,0,0.04);border-left:4px solid var(--azul-petroleo);transition:box-shadow .15s}
.stat-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.06)}
.stat-card.accent-orange{border-left-color:var(--laranja)}
.stat-card.accent-green{border-left-color:var(--success)}
.stat-label{font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;margin-bottom:6px;letter-spacing:.03em}
.stat-value{font-size:26px;font-weight:700;color:var(--grafite)}
.stat-meta{font-size:10px;color:var(--text-muted);margin-top:6px}
.stat-card.disabled{opacity:.5}
.stat-card.disabled .stat-meta{font-style:italic}

/* CARD */
.card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,0.04);margin-bottom:16px}
.card-title{font-size:13px;font-weight:700;color:var(--grafite);margin-bottom:14px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;border:none;transition:all .12s}
.btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}
.btn-primary{background:var(--azul-petroleo);color:#fff}
.btn-primary:hover{background:var(--azul-petroleo-light)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-secondary{background:transparent;color:var(--azul-petroleo);border:1.5px solid var(--azul-petroleo)}
.btn-secondary:hover{background:var(--info-bg)}
.btn-secondary:disabled{opacity:.4;cursor:not-allowed}
.btn-ghost{background:transparent;color:var(--text-muted);border:1.5px solid var(--border)}
.btn-ghost:hover{border-color:#bbb;color:var(--grafite)}
.btn-success{background:var(--success);color:#fff}
.btn-success:hover{background:#1b5e20}
.btn.hidden{display:none}
.quick-actions{display:flex;gap:10px;flex-wrap:wrap}

/* SEARCH & FILTERS */
.search-bar{display:flex;gap:10px;margin-bottom:14px}
.search-bar input{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit;background:#fff;color:var(--grafite);outline:none;transition:border-color .15s}
.search-bar input:focus{border-color:var(--azul-petroleo)}
.search-bar input::placeholder{color:#aaa}

.filters-row{display:flex;gap:14px;align-items:flex-end;flex-wrap:wrap}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-group label{font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.02em}
.filter-group select,.filter-group input{padding:8px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit;background:#fff;color:var(--grafite);outline:none;transition:border-color .15s}
.filter-group select:focus,.filter-group input:focus{border-color:var(--azul-petroleo)}
.filter-group input[type="number"]{width:120px}
.filter-group select{min-width:115px}

/* PROCESSO CARD */
.processo-card{background:#fff;border-radius:10px;padding:18px;box-shadow:0 1px 4px rgba(0,0,0,0.04);margin-bottom:12px;border:1.5px solid transparent;cursor:pointer;transition:all .12s}
.processo-card:hover{border-color:var(--azul-petroleo);box-shadow:0 4px 16px rgba(0,96,100,0.1);transform:translateY(-1px)}
.processo-header{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:14px}
.processo-header-left{flex:1;min-width:0}
.processo-top{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap}
.processo-cnj{font-size:13px;font-weight:700;font-family:var(--font-mono);color:var(--azul-petroleo)}
.tribunal-badge{font-size:9px;font-weight:700;color:#fff;background:var(--azul-petroleo);padding:3px 8px;border-radius:4px;text-transform:uppercase}
.tribunal-badge.tjgo{background:var(--laranja)}
.processo-classe{font-size:11px;color:var(--text-muted);margin-top:2px}
.processo-header-right{text-align:right;flex-shrink:0}
.processo-valor{font-size:18px;font-weight:700;color:var(--success)}
.processo-status{font-size:9px;font-weight:600;padding:3px 10px;border-radius:10px;margin-top:4px;display:inline-block}
.processo-status.normalizado{color:var(--success);background:var(--success-bg)}
.processo-status.processando{color:var(--warning);background:var(--warning-bg)}
.processo-status.erro{color:var(--error);background:var(--error-bg)}
.processo-body{display:grid;grid-template-columns:1fr 1fr;gap:10px 20px;font-size:12px}
.processo-label{font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:2px}
.processo-value{color:var(--grafite);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* RESULTS */
.results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
.results-count{font-size:12px;color:var(--text-muted)}
.results-actions{display:flex;align-items:center;gap:12px}
.results-limit{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted)}
.results-limit select{padding:5px 8px;border:1px solid var(--border);border-radius:5px;font-size:11px;font-family:inherit;background:#fff;cursor:pointer}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:center;gap:14px;margin-top:20px;padding-top:20px;border-top:1px solid var(--border-light)}
.pagination-btn{padding:8px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;border:1.5px solid var(--border);background:#fff;color:var(--grafite);display:flex;align-items:center;gap:5px;transition:all .12s}
.pagination-btn:hover:not(:disabled){border-color:var(--azul-petroleo);color:var(--azul-petroleo);background:var(--info-bg)}
.pagination-btn:disabled{opacity:.35;cursor:not-allowed}
.pagination-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}
.pagination-info{font-size:12px;color:var(--text-muted);font-weight:500}
.pagination-info strong{color:var(--grafite)}

/* LOADING & EMPTY */
.loading-container{display:flex;flex-direction:column;align-items:center;padding:50px 20px;color:var(--text-muted)}
.loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--azul-petroleo);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:12px}
.loading-text{font-size:13px}
.empty-state{text-align:center;padding:50px 20px;color:var(--text-muted)}
.empty-icon{font-size:42px;margin-bottom:12px;opacity:.25}
.empty-title{font-size:14px;font-weight:600;margin-bottom:4px;color:var(--grafite)}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(2px)}
.modal-overlay.active{display:flex}
.modal{background:#fff;border-radius:12px;padding:24px;width:92%;max-width:640px;max-height:85vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2);animation:fadeUp .2s ease}
.modal-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px}
.modal-badges{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modal-cnj{font-size:15px;font-weight:700;font-family:var(--font-mono);color:var(--azul-petroleo)}
.modal-valor{font-size:22px;font-weight:700;color:var(--success);margin-top:8px}
.modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;border-radius:6px;transition:all .12s}
.modal-close:hover{color:var(--grafite);background:var(--off-white)}
.modal-close svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.modal-loading{display:flex;flex-direction:column;align-items:center;padding:50px;color:var(--text-muted)}
.modal-loading .loading-spinner{margin-bottom:12px}
.modal-section{margin-bottom:20px}
.modal-section-title{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border-light);letter-spacing:.03em}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.modal-label{font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:2px}
.modal-value{font-size:13px;font-weight:500;color:var(--grafite)}
.modal-actions{display:flex;gap:10px;margin-top:20px;padding-top:20px;border-top:1px solid var(--border-light)}

/* PARTES */
.parte-card{background:var(--off-white);border-radius:8px;padding:14px;margin-bottom:10px}
.parte-papel{font-size:9px;font-weight:700;text-transform:uppercase;padding:3px 8px;border-radius:4px;display:inline-block;margin-bottom:6px}
.parte-papel.autor{color:var(--azul-petroleo);background:var(--info-bg)}
.parte-papel.reu{color:var(--laranja);background:rgba(255,64,16,0.1)}
.parte-nome{font-size:13px;font-weight:600;color:var(--grafite)}
.parte-adv{font-size:11px;color:var(--text-muted);margin-top:8px}

/* EXPORT */
.export-option{display:flex;align-items:center;gap:14px;padding:18px;background:#fff;border:1.5px solid var(--border);border-radius:10px;cursor:pointer;margin-bottom:12px;transition:all .12s}
.export-option:hover{border-color:var(--azul-petroleo)}
.export-option.selected{border-color:var(--azul-petroleo);background:var(--info-bg)}
.export-option.disabled{opacity:.45;cursor:not-allowed;pointer-events:none}
.export-icon{font-size:28px}
.export-title{font-size:14px;font-weight:600;color:var(--grafite)}
.export-desc{font-size:11px;color:var(--text-muted);margin-top:3px}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--success);color:#fff;padding:12px 18px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.2);z-index:200;font-size:13px;font-weight:500;display:none;align-items:center;gap:8px;animation:fadeUp .2s ease}
.toast.active{display:flex}
.toast.error{background:var(--error)}

/* DEMO BANNER */
.demo-banner{background:linear-gradient(135deg,#fff8e1 0%,#ffecb3 100%);border:1px solid #ffca28;color:#f57c00;padding:10px 14px;border-radius:8px;font-size:12px;margin-bottom:16px;display:none;align-items:center;gap:8px;font-weight:500}
.demo-banner.active{display:flex}

/* RESPONSIVE */
@media(max-width:900px){.stats-grid{grid-template-columns:1fr 1fr}.modal-grid{grid-template-columns:1fr}.main{padding:18px 20px;margin-left:190px}.sidebar{width:190px;min-width:190px}.processo-body{grid-template-columns:1fr}}
@media(max-width:700px){.sidebar{display:none}.main{margin-left:0}.stats-grid{grid-template-columns:1fr}.filters-row{flex-direction:column;align-items:stretch}.filter-group select,.filter-group input{width:100%}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-wrapper">
<div class="login-bg"></div>
<div class="login-container">
<div class="login-brand">
<div class="login-brand-name">Opportium</div>
<div class="login-product">Legal<span>Scraper</span></div>
</div>
<div class="login-card">
<div class="login-title">Bem-vindo</div>
<div class="login-subtitle">Entre com suas credenciais para acessar</div>
<div id="loginError" class="login-error" style="display:none"><span>‚ö†</span><span id="loginErrorText"></span></div>
<div class="field-group"><label>Usu√°rio</label><input type="text" id="loginUsername" placeholder="Digite seu usu√°rio"></div>
<div class="field-group"><label>Senha</label><div class="password-wrap"><input type="password" id="loginPassword" placeholder="Digite sua senha"><button type="button" class="password-toggle" onclick="togglePassword()">Mostrar</button></div></div>
<div id="captchaBox" class="captcha-box" onclick="toggleCaptcha()"><div class="captcha-checkbox"><svg class="captcha-check" style="display:none" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><span class="captcha-label">N√£o sou um rob√¥</span><span class="captcha-brand">hCaptcha</span></div>
<button class="login-btn" id="loginBtn" onclick="handleLogin()">Entrar</button>
</div>
<div class="login-footer">v1.7.3</div>
</div>
<div class="watermark">¬© 2026 Opportium</div>
</div>

<!-- APP -->
<div id="app" class="app">
<aside class="sidebar">
<div class="logo">
<div class="logo-text">Opportium</div>
<div class="logo-product">Legal<span>Scraper</span></div>
</div>
<div class="menu-label">Menu</div>
<nav>
<button class="nav-item active" data-page="inicio" onclick="showPage('inicio',this)"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> In√≠cio</button>
<button class="nav-item" data-page="consultar" onclick="showPage('consultar',this)"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Consultar</button>
<button class="nav-item" id="navWatchlist" data-page="watchlist" onclick="showPage('watchlist',this)"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Watchlist <span class="nav-badge" id="watchBadge">0</span></button>
<button class="nav-item" data-page="exportar" onclick="showPage('exportar',this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Exportar</button>
</nav>
<div class="sidebar-footer">
<div class="sidebar-user">
<div class="sidebar-avatar" id="sidebarAvatar">U</div>
<div class="sidebar-user-info">
<div class="sidebar-user-name" id="sidebarName">Usu√°rio</div>
<div class="sidebar-user-role" id="sidebarRole">Operador</div>
</div>
<button class="sidebar-logout" onclick="handleLogout()" title="Sair"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
</div>
</div>
</aside>

<main class="main">
<div id="demoBanner" class="demo-banner"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> <span>Modo demonstra√ß√£o ‚Äî algumas funcionalidades est√£o restritas</span></div>

<!-- IN√çCIO -->
<div id="page-inicio" class="page active">
<div class="page-header"><div class="page-title">Painel</div><div class="page-subtitle">Resumo de acompanhamento processual</div></div>
<div class="stats-grid">
<div class="stat-card" id="statCardWatched"><div class="stat-label">Processos Monitorados</div><div class="stat-value" id="statWatched">0</div><div class="stat-meta" id="statWatchedMeta">Na sua watchlist</div></div>
<div class="stat-card accent-orange"><div class="stat-label">Maior Valor em Causa</div><div class="stat-value" id="statMaiorValor">-</div><div class="stat-meta">Na base de dados</div></div>
<div class="stat-card accent-green"><div class="stat-label">Total na Base</div><div class="stat-value" id="statTotal">-</div><div class="stat-meta">Processos dispon√≠veis</div></div>
</div>
<div class="card">
<div class="card-title">A√ß√µes R√°pidas</div>
<div class="quick-actions">
<button class="btn btn-primary" onclick="showPage('consultar',document.querySelector('[data-page=consultar]'))"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Nova Consulta</button>
<button class="btn btn-secondary" id="btnQuickWatchlist" onclick="showPage('watchlist',document.querySelector('[data-page=watchlist]'))"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Ver Watchlist</button>
<button class="btn btn-secondary" onclick="showPage('exportar',document.querySelector('[data-page=exportar]'))"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Exportar</button>
</div>
</div>
</div>

<!-- CONSULTAR -->
<div id="page-consultar" class="page">
<div class="page-header"><div class="page-title">Consultar Processos</div><div class="page-subtitle">Busque por nome da parte, tribunal ou valor</div></div>
<div class="card">
<div class="search-bar">
<input type="text" id="searchInput" placeholder="Buscar por nome da parte...">
<button class="btn btn-primary" id="searchBtn" onclick="doSearch(1)"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Buscar</button>
</div>
<div class="filters-row">
<div class="filter-group"><label>Tribunal</label><select id="filterTribunal"><option value="">Todos</option><option value="TJSP">TJSP</option><option value="TJGO">TJGO</option></select></div>
<div class="filter-group"><label>Tipo Parte</label><select id="filterTipoParte"><option value="">Ambos</option><option value="autor">Autor</option><option value="reu">R√©u</option></select></div>
<div class="filter-group"><label>Valor m√≠nimo</label><input type="number" id="filterValorMin" placeholder="Ex: 10000" min="0"></div>
<div class="filter-group" style="align-self:flex-end"><button class="btn btn-ghost" onclick="clearFilters()"><svg viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg> Limpar</button></div>
</div>
</div>
<div id="searchLoading" class="loading-container" style="display:none"><div class="loading-spinner"></div><div class="loading-text">Buscando processos...</div></div>
<div id="searchEmpty" class="empty-state"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-title">Fa√ßa uma consulta</div><div style="font-size:12px;margin-top:4px;color:var(--text-muted)">Use os filtros acima e clique em Buscar</div></div>
<div id="searchError" class="empty-state" style="display:none"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Erro na busca</div><div id="searchErrorText" style="font-size:12px;margin-top:4px;color:var(--text-muted)"></div></div>
<div id="searchResultsHeader" class="results-header" style="display:none"><div class="results-count" id="searchResultsCount"></div><div class="results-actions"><div class="results-limit"><span>Por p√°gina:</span><select id="searchLimit" onchange="doSearch(1)"><option value="20">20</option><option value="50">50</option><option value="100">100</option></select></div></div></div>
<div id="searchResults"></div>
<div id="paginationContainer" class="pagination" style="display:none"><button class="pagination-btn" id="btnPrev" onclick="goToPage(currentPage-1)"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg> Anterior</button><div class="pagination-info"><strong id="pageInfo">P√°gina 1 de 1</strong></div><button class="pagination-btn" id="btnNext" onclick="goToPage(currentPage+1)">Pr√≥ximo <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button></div>
</div>

<!-- WATCHLIST -->
<div id="page-watchlist" class="page">
<div class="page-header"><div class="page-title">Watchlist</div><div class="page-subtitle" id="watchSubtitle">Processos monitorados</div></div>
<div id="watchLoading" class="loading-container" style="display:none"><div class="loading-spinner"></div><div class="loading-text">Carregando watchlist...</div></div>
<div id="watchResults"></div>
<div id="watchEmpty" class="empty-state"><div class="empty-icon">üëÅÔ∏è</div><div class="empty-title">Watchlist vazia</div><div style="font-size:12px;margin-top:4px;color:var(--text-muted)">Adicione processos para monitorar</div></div>
</div>

<!-- EXPORTAR -->
<div id="page-exportar" class="page">
<div class="page-header"><div class="page-title">Exportar Dados</div><div class="page-subtitle">Baixe os dados em formato Excel</div></div>
<div class="card">
<div class="card-title">Selecione a origem dos dados</div>
<div class="export-option selected" onclick="selectExportOption(this,'busca')"><div class="export-icon">üìä</div><div class="export-info"><div class="export-title">√öltima Busca</div><div class="export-desc" id="exportBuscaDesc">Nenhuma busca realizada</div></div></div>
<div class="export-option" id="exportWatchlistOption" onclick="selectExportOption(this,'watchlist')"><div class="export-icon">üëÅÔ∏è</div><div class="export-info"><div class="export-title">Watchlist</div><div class="export-desc" id="exportWatchDesc">0 processos</div></div></div>
</div>
<button class="btn btn-success" onclick="exportToExcel()" style="margin-top:6px"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Baixar Excel</button>
</div>
</main>
<div class="watermark watermark-app">¬© 2026 Opportium</div>
</div>

<!-- MODAL -->
<div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
<div class="modal" onclick="event.stopPropagation()">
<div class="modal-header">
<div>
<div class="modal-badges"><span id="modalTribunal" class="tribunal-badge"></span><span id="modalStatus" class="processo-status normalizado"></span></div>
<div id="modalCNJ" class="modal-cnj"></div>
<div id="modalValor" class="modal-valor"></div>
</div>
<button class="modal-close" onclick="closeModal()"><svg viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
</div>
<div id="modalLoading" class="modal-loading"><div class="loading-spinner"></div><div class="loading-text">Carregando detalhes...</div></div>
<div id="modalContent" style="display:none">
<div class="modal-section"><div class="modal-section-title">Informa√ß√µes do Processo</div><div class="modal-grid" id="modalGridInfo"></div></div>
<div class="modal-section"><div class="modal-section-title">Partes Envolvidas</div><div id="modalPartes"></div></div>
<div class="modal-section" id="modalMovSection" style="display:none"><div class="modal-section-title">√öltima Movimenta√ß√£o</div><div id="modalMov"></div></div>
<div class="modal-actions">
<button class="btn btn-primary" id="modalWatchBtn" onclick="addToWatchlist()"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Adicionar √† Watchlist</button>
<button class="btn btn-secondary" onclick="closeModal()">Fechar</button>
</div>
</div>
</div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"><span id="toastIcon">‚úì</span><span id="toastMsg"></span></div>

<script>
const API_BASE='https://legalscraper-c5a19f03fe5f.herokuapp.com',API_VERSION='/v1';
let token=null,currentUser=null,currentProcesso=null,watchlistCache=[],lastSearchResults=[],exportType='busca',totalProcessos=0,maiorValor=0;
let currentPage=1,totalPages=1,currentLimit=20;

const PERMISSIONS={'frontend_ops':{watchlist:true},'frontend_user':{watchlist:true},'demo_user':{watchlist:false},'demo':{watchlist:false},'default':{watchlist:true}};
const getUserPermissions=()=>{if(!currentUser||!currentUser.role)return PERMISSIONS.default;return PERMISSIONS[currentUser.role.toLowerCase()]||PERMISSIONS.default};
const canUseWatchlist=()=>getUserPermissions().watchlist;
const isDemoUser=()=>currentUser&&currentUser.role&&currentUser.role.toLowerCase().includes('demo');

const applyPermissions=()=>{
  const p=getUserPermissions();
  const isDemo=isDemoUser();
  // Sidebar watchlist
  document.getElementById('navWatchlist').classList.toggle('hidden',!p.watchlist);
  // Card de watchlist - mostrar mas com estado diferente para demo
  const cardWatched=document.getElementById('statCardWatched');
  if(isDemo){
    cardWatched.classList.add('disabled');
    document.getElementById('statWatched').textContent='-';
    document.getElementById('statWatchedMeta').textContent='N√£o dispon√≠vel no modo demo';
  }else{
    cardWatched.classList.remove('disabled');
    document.getElementById('statWatchedMeta').textContent='Na sua watchlist';
  }
  // Bot√£o watchlist
  const btnQuick=document.getElementById('btnQuickWatchlist');
  if(isDemo){btnQuick.disabled=true;btnQuick.classList.add('hidden')}else{btnQuick.disabled=false;btnQuick.classList.remove('hidden')}
  // Modal btn
  document.getElementById('modalWatchBtn').classList.toggle('hidden',!p.watchlist);
  // Export option
  const ew=document.getElementById('exportWatchlistOption');
  ew.classList.toggle('disabled',!p.watchlist);
  if(!p.watchlist){ew.classList.remove('selected');document.querySelector('.export-option').classList.add('selected');exportType='busca'}
  // Banner
  document.getElementById('demoBanner').classList.toggle('active',isDemo);
};

const formatCNJ=n=>{if(!n)return'-';const s=String(n).replace(/\D/g,'');return s.length===20?s.slice(0,7)+'-'+s.slice(7,9)+'.'+s.slice(9,13)+'.'+s.slice(13,14)+'.'+s.slice(14,16)+'.'+s.slice(16,20):n};
const formatCurrency=v=>v!=null?new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v):null;
const formatCurrencyShort=v=>{if(v==null)return'-';if(v>=1e9)return'R$ '+(v/1e9).toFixed(2)+'B';if(v>=1e6)return'R$ '+(v/1e6).toFixed(2)+'M';if(v>=1e3)return'R$ '+(v/1e3).toFixed(0)+'K';return formatCurrency(v)};
const formatDate=d=>{if(!d)return null;if(typeof d==='string'&&d.includes('/'))return d;try{return new Date(d).toLocaleDateString('pt-BR')}catch{return d}};
const getTribunalClass=t=>t&&t.toUpperCase().includes('TJGO')?'tjgo':'';
const getStatusClass=s=>{if(!s)return'normalizado';const x=s.toUpperCase();return x.includes('PROCESSANDO')?'processando':x.includes('ERRO')?'erro':'normalizado'};
const getStatusLabel=s=>{if(!s)return'OK';const x=s.toUpperCase();return x.includes('PROCESSANDO')?'Processando':x.includes('ERRO')?'Erro':'OK'};
const truncate=(s,l=45)=>!s?'-':s.length>l?s.substring(0,l)+'...':s;
const showToast=(m,e=false)=>{const t=document.getElementById('toast');document.getElementById('toastMsg').textContent=m;document.getElementById('toastIcon').textContent=e?'‚úï':'‚úì';t.className='toast active'+(e?' error':'');setTimeout(()=>t.classList.remove('active'),3000)};
const apiCall=async(ep,opt={})=>{const h={'Content-Type':'application/json',...opt.headers};if(token)h['Authorization']='Bearer '+token;const r=await fetch(API_BASE+API_VERSION+ep,{...opt,headers:h});if(r.status===401){showToast('Sess√£o expirada',true);handleLogout();throw new Error('401')}if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.detail||e.message||'Erro')}return r.json()};

let captchaChecked=false;
const togglePassword=()=>{const i=document.getElementById('loginPassword'),b=document.querySelector('.password-toggle');i.type=i.type==='password'?'text':'password';b.textContent=i.type==='password'?'Mostrar':'Ocultar'};
const toggleCaptcha=()=>{captchaChecked=!captchaChecked;const b=document.getElementById('captchaBox');b.classList.toggle('checked',captchaChecked);b.querySelector('.captcha-check').style.display=captchaChecked?'block':'none'};

const handleLogin=async()=>{
  const u=document.getElementById('loginUsername').value.trim(),p=document.getElementById('loginPassword').value;
  const err=document.getElementById('loginError'),errT=document.getElementById('loginErrorText'),btn=document.getElementById('loginBtn');
  if(!u||!p){err.style.display='flex';errT.textContent='Preencha usu√°rio e senha';return}
  if(!captchaChecked){err.style.display='flex';errT.textContent='Confirme que n√£o √© um rob√¥';return}
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Entrando...';err.style.display='none';
  try{
    const r=await fetch(API_BASE+API_VERSION+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
    if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.detail||'Credenciais inv√°lidas')}
    const d=await r.json();
    token=d.access_token;currentUser={username:u,role:d.role||'frontend_user'};
    localStorage.setItem('ls_token',token);localStorage.setItem('ls_user',JSON.stringify(currentUser));
    document.getElementById('sidebarName').textContent=u;
    document.getElementById('sidebarRole').textContent=currentUser.role;
    document.getElementById('sidebarAvatar').textContent=u.charAt(0).toUpperCase();
    document.getElementById('loginPage').style.display='none';
    document.getElementById('app').classList.add('active');
    applyPermissions();initApp();
  }catch(e){err.style.display='flex';errT.textContent=e.message}
  btn.disabled=false;btn.innerHTML='Entrar';
};

const handleLogout=()=>{
  token=null;currentUser=null;localStorage.removeItem('ls_token');localStorage.removeItem('ls_user');
  document.getElementById('app').classList.remove('active');document.getElementById('loginPage').style.display='flex';
  document.getElementById('loginUsername').value='';document.getElementById('loginPassword').value='';
  captchaChecked=false;document.getElementById('captchaBox').classList.remove('checked');document.querySelector('.captcha-check').style.display='none';
};

const initApp=async()=>{
  if(canUseWatchlist())loadWatchlist();
  try{
    const d=await apiCall('/processos?limit=100');
    const lista=d.data||d.items||[];
    if(d.total_count){totalProcessos=d.total_count;document.getElementById('statTotal').textContent=totalProcessos.toLocaleString('pt-BR')}
    if(lista.length>0){maiorValor=Math.max(...lista.map(p=>p.valor_causa||0));document.getElementById('statMaiorValor').textContent=formatCurrencyShort(maiorValor)}
  }catch(e){}
};

const showPage=(id,el)=>{
  if(id==='watchlist'&&!canUseWatchlist()){showToast('N√£o dispon√≠vel no modo demo',true);return}
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  if(id==='watchlist'&&canUseWatchlist())loadWatchlist();
  if(id==='exportar')updateExportDesc();
};

const clearFilters=()=>{
  document.getElementById('searchInput').value='';
  document.getElementById('filterTribunal').value='';
  document.getElementById('filterTipoParte').value='';
  document.getElementById('filterValorMin').value='';
  document.getElementById('searchResults').innerHTML='';
  document.getElementById('searchResultsHeader').style.display='none';
  document.getElementById('paginationContainer').style.display='none';
  document.getElementById('searchEmpty').style.display='block';
  lastSearchResults=[];currentPage=1;
};

const goToPage=page=>{if(page<1||page>totalPages)return;doSearch(page)};

const doSearch=async(page=1)=>{
  currentLimit=parseInt(document.getElementById('searchLimit').value);
  const offset=(page-1)*currentLimit;
  const txt=document.getElementById('searchInput').value.trim();
  const tribunal=document.getElementById('filterTribunal').value;
  const tipoParte=document.getElementById('filterTipoParte').value;
  const valorMin=document.getElementById('filterValorMin').value;
  
  document.getElementById('searchLoading').style.display='flex';
  document.getElementById('searchEmpty').style.display='none';
  document.getElementById('searchError').style.display='none';
  document.getElementById('searchResults').innerHTML='';
  document.getElementById('searchResultsHeader').style.display='none';
  document.getElementById('paginationContainer').style.display='none';
  document.getElementById('searchBtn').disabled=true;
  
  try{
    let ep='/processos?limit='+currentLimit+'&offset='+offset;
    if(tribunal)ep+='&tribunal='+tribunal;
    if(txt){
      if(tipoParte==='autor')ep+='&autor='+encodeURIComponent(txt);
      else if(tipoParte==='reu')ep+='&reu='+encodeURIComponent(txt);
      else ep+='&nome_part='+encodeURIComponent(txt);
    }
    if(valorMin)ep+='&valor_min='+valorMin;
    
    const res=await apiCall(ep);
    let lista=res.data||res.items||res.processos||(Array.isArray(res)?res:[]);
    lista.sort((a,b)=>(b.valor_causa||0)-(a.valor_causa||0));
    lastSearchResults=lista;
    const total=res.total_count||lista.length;
    totalProcessos=total;
    totalPages=Math.ceil(total/currentLimit)||1;
    currentPage=page;
    
    document.getElementById('statTotal').textContent=total.toLocaleString('pt-BR');
    if(lista.length>0){
      const mv=Math.max(...lista.map(p=>p.valor_causa||0));
      if(mv>maiorValor){maiorValor=mv;document.getElementById('statMaiorValor').textContent=formatCurrencyShort(maiorValor)}
    }
    
    document.getElementById('searchLoading').style.display='none';
    
    if(lista.length===0){
      document.getElementById('searchEmpty').innerHTML='<div class="empty-icon">üîç</div><div class="empty-title">Nenhum resultado encontrado</div><div style="font-size:12px;margin-top:4px;color:var(--text-muted)">Tente ajustar os filtros da busca</div>';
      document.getElementById('searchEmpty').style.display='block';
    }else{
      document.getElementById('searchResultsHeader').style.display='flex';
      const start=offset+1,end=Math.min(offset+lista.length,total);
      document.getElementById('searchResultsCount').textContent='Exibindo '+start+'‚Äì'+end+' de '+total.toLocaleString('pt-BR')+' processos';
      document.getElementById('searchResults').innerHTML=lista.map(renderCard).join('');
      document.getElementById('paginationContainer').style.display='flex';
      document.getElementById('pageInfo').textContent='P√°gina '+currentPage+' de '+totalPages;
      document.getElementById('btnPrev').disabled=currentPage<=1;
      document.getElementById('btnNext').disabled=currentPage>=totalPages;
    }
  }catch(e){
    document.getElementById('searchLoading').style.display='none';
    document.getElementById('searchError').style.display='block';
    document.getElementById('searchErrorText').textContent=e.message;
  }
  document.getElementById('searchBtn').disabled=false;
};

const renderCard=p=>{
  const num=p.processo_numero||'',cnj=formatCNJ(num),trib=p.tribunal||'-',valor=p.valor_causa,status=p.status_processamento||'';
  const classe=p.classe||'',assunto=p.assunto||'',foro=p.foro||'',vara=p.vara||'',autor=p.autor||'',reu=p.reu||'';
  const tc=getTribunalClass(trib),sc=getStatusClass(status),sl=getStatusLabel(status),vs=formatCurrency(valor);
  let loc='-';if(foro&&vara)loc=foro+' ‚Äî '+vara;else if(foro)loc=foro;else if(vara)loc=vara;
  return '<div class="processo-card" onclick="openModal(\''+num+'\')">'
    +'<div class="processo-header"><div class="processo-header-left">'
    +'<div class="processo-top"><span class="processo-cnj">'+cnj+'</span><span class="tribunal-badge '+tc+'">'+trib+'</span></div>'
    +(classe?'<div class="processo-classe">'+truncate(classe,55)+'</div>':'')
    +'</div><div class="processo-header-right">'+(vs?'<div class="processo-valor">'+vs+'</div>':'')
    +'<span class="processo-status '+sc+'">'+sl+'</span></div></div>'
    +'<div class="processo-body">'
    +'<div class="processo-field"><div class="processo-label">Autor</div><div class="processo-value" title="'+autor+'">'+truncate(autor)+'</div></div>'
    +'<div class="processo-field"><div class="processo-label">R√©u</div><div class="processo-value" title="'+reu+'">'+truncate(reu)+'</div></div>'
    +'<div class="processo-field"><div class="processo-label">Foro / Vara</div><div class="processo-value" title="'+loc+'">'+truncate(loc)+'</div></div>'
    +'<div class="processo-field"><div class="processo-label">Assunto</div><div class="processo-value" title="'+assunto+'">'+truncate(assunto)+'</div></div>'
    +'</div></div>';
};

const openModal=async num=>{
  document.getElementById('modalLoading').style.display='flex';
  document.getElementById('modalContent').style.display='none';
  document.getElementById('modalCNJ').textContent=formatCNJ(num);
  document.getElementById('modalTribunal').textContent='...';
  document.getElementById('modalStatus').textContent='...';
  document.getElementById('modalValor').textContent='';
  document.getElementById('modalOverlay').classList.add('active');
  try{
    const p=await apiCall('/processos/'+encodeURIComponent(num));
    currentProcesso=p;
    document.getElementById('modalTribunal').className='tribunal-badge '+getTribunalClass(p.tribunal);
    document.getElementById('modalTribunal').textContent=p.tribunal||'-';
    document.getElementById('modalStatus').className='processo-status '+getStatusClass(p.status_processamento);
    document.getElementById('modalStatus').textContent=getStatusLabel(p.status_processamento);
    document.getElementById('modalCNJ').textContent=formatCNJ(p.processo_numero);
    document.getElementById('modalValor').textContent=formatCurrency(p.valor_causa)||'';
    const campos=[['Classe',p.classe],['Assunto',p.assunto],['Foro',p.foro],['Vara',p.vara],['Juiz',p.juiz],['Distribui√ß√£o',p.distribuicao_data||formatDate(p.data_distribuicao)],['√Årea',p.area],['Inst√¢ncia',p.instancia],['Sistema',p.sistema_origem?p.sistema_origem.toUpperCase():''],['Atualiza√ß√£o',formatDate(p.ultima_atualizacao)]].filter(function(c){return c[1]&&c[1]!=='-'&&c[1]!=='null'});
    document.getElementById('modalGridInfo').innerHTML=campos.map(function(c){return '<div><div class="modal-label">'+c[0]+'</div><div class="modal-value">'+c[1]+'</div></div>'}).join('');
    renderPartes(p.partes||[],p.autor,p.reu);
    if(p.ultima_movimentacao_texto||p.ultima_movimentacao_data){
      document.getElementById('modalMovSection').style.display='block';
      document.getElementById('modalMov').innerHTML='<div style="background:var(--off-white);border-radius:8px;padding:12px">'+(p.ultima_movimentacao_data?'<div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">'+p.ultima_movimentacao_data+'</div>':'')+'<div style="font-size:12px">'+( p.ultima_movimentacao_texto||'-')+'</div></div>';
    }else{document.getElementById('modalMovSection').style.display='none'}
    document.getElementById('modalLoading').style.display='none';
    document.getElementById('modalContent').style.display='block';
  }catch(e){showToast('Erro: '+e.message,true);closeModal()}
};

const renderPartes=(partes,autorStr,reuStr)=>{
  const c=document.getElementById('modalPartes');
  if(partes&&partes.length>0){
    c.innerHTML=partes.map(function(p){
      const papel=(p.papel||'PARTE').toUpperCase(),isA=papel.includes('AUTOR')||papel.includes('REQUERENTE')||papel.includes('EXEQUENTE');
      const advs=p.representantes||[];
      let ah='';if(advs.length>0)ah='<div class="parte-adv">Advogado(s): '+advs.map(function(a){let o='';if(a.numero_oab&&a.uf_oab)o=' (OAB/'+a.uf_oab+' '+a.numero_oab+')';return a.nome+o}).join(', ')+'</div>';
      return '<div class="parte-card"><span class="parte-papel '+(isA?'autor':'reu')+'">'+papel+'</span><div class="parte-nome">'+(p.nome||'-')+'</div>'+ah+'</div>';
    }).join('');
    return;
  }
  let h='';
  if(autorStr)h+='<div class="parte-card"><span class="parte-papel autor">AUTOR</span><div class="parte-nome">'+autorStr+'</div></div>';
  if(reuStr)h+='<div class="parte-card"><span class="parte-papel reu">R√âU</span><div class="parte-nome">'+reuStr+'</div></div>';
  c.innerHTML=h||'<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:16px">Nenhuma parte encontrada</div>';
};

const closeModal=()=>{document.getElementById('modalOverlay').classList.remove('active');currentProcesso=null};

const loadWatchlist=async()=>{
  if(!canUseWatchlist())return;
  document.getElementById('watchLoading').style.display='flex';
  document.getElementById('watchResults').innerHTML='';
  document.getElementById('watchEmpty').style.display='none';
  try{
    const d=await apiCall('/watchlist');
    watchlistCache=d.data||d.items||d.watchlist||(Array.isArray(d)?d:[]);
    document.getElementById('watchLoading').style.display='none';
    document.getElementById('watchBadge').textContent=watchlistCache.length;
    document.getElementById('statWatched').textContent=watchlistCache.length;
    document.getElementById('watchSubtitle').textContent=watchlistCache.length+' processo(s) monitorado(s)';
    if(watchlistCache.length===0){document.getElementById('watchEmpty').style.display='block'}
    else{
      document.getElementById('watchResults').innerHTML=watchlistCache.map(function(w){
        const n=w.processo_numero||w.cnj||'';
        return '<div class="processo-card" onclick="openModal(\''+n+'\')"><div class="processo-header"><div class="processo-header-left"><div class="processo-top"><span class="processo-cnj">'+formatCNJ(n)+'</span></div></div><div class="processo-header-right"><span style="font-size:10px;color:var(--text-muted)">Adicionado: '+(formatDate(w.created_at)||'-')+'</span></div></div></div>';
      }).join('');
    }
  }catch(e){
    document.getElementById('watchLoading').style.display='none';
    document.getElementById('watchEmpty').innerHTML='<div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Erro ao carregar</div><div style="font-size:12px;margin-top:4px;color:var(--text-muted)">'+e.message+'</div>';
    document.getElementById('watchEmpty').style.display='block';
  }
};

const addToWatchlist=async()=>{
  if(!canUseWatchlist()){showToast('N√£o dispon√≠vel no modo demo',true);return}
  if(!currentProcesso)return;
  const n=currentProcesso.processo_numero,btn=document.getElementById('modalWatchBtn');
  btn.disabled=true;btn.innerHTML='<span class="loading-spinner" style="width:14px;height:14px;border-width:2px"></span> Adicionando...';
  try{
    await apiCall('/watchlist',{method:'POST',body:JSON.stringify({processo_numero:n})});
    showToast('Processo adicionado √† watchlist');
    closeModal();loadWatchlist();
  }catch(e){showToast('Erro: '+e.message,true)}
  btn.disabled=false;
  btn.innerHTML='<svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Adicionar √† Watchlist';
};

const selectExportOption=(el,t)=>{
  if(t==='watchlist'&&!canUseWatchlist())return;
  document.querySelectorAll('.export-option').forEach(function(o){o.classList.remove('selected')});
  el.classList.add('selected');exportType=t;
};

const updateExportDesc=()=>{
  document.getElementById('exportBuscaDesc').textContent=lastSearchResults.length>0?lastSearchResults.length+' processos da √∫ltima busca':'Nenhuma busca realizada';
  document.getElementById('exportWatchDesc').textContent=canUseWatchlist()?watchlistCache.length+' processos na watchlist':'N√£o dispon√≠vel';
};

const exportToExcel=()=>{
  const d=exportType==='busca'?lastSearchResults:watchlistCache;
  if(d.length===0){showToast('Nenhum dado para exportar',true);return}
  const rows=d.map(function(p){
    return{'N√∫mero CNJ':formatCNJ(p.processo_numero),'Tribunal':p.tribunal||'-','Classe':p.classe||'-','Assunto':p.assunto||'-','Autor':p.autor||'-','R√©u':p.reu||'-','Foro':p.foro||'-','Vara':p.vara||'-','Valor (R$)':p.valor_causa||0,'Status':p.status_processamento||'-'};
  });
  const ws=XLSX.utils.json_to_sheet(rows),wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Processos');
  XLSX.writeFile(wb,'legalscraper_export_'+new Date().toISOString().slice(0,10)+'.xlsx');
  showToast('Arquivo Excel gerado com sucesso');
};

document.addEventListener('DOMContentLoaded',function(){
  const st=localStorage.getItem('ls_token'),su=localStorage.getItem('ls_user');
  if(st&&su){
    token=st;currentUser=JSON.parse(su);
    document.getElementById('sidebarName').textContent=currentUser.username;
    document.getElementById('sidebarRole').textContent=currentUser.role;
    document.getElementById('sidebarAvatar').textContent=currentUser.username.charAt(0).toUpperCase();
    document.getElementById('loginPage').style.display='none';
    document.getElementById('app').classList.add('active');
    applyPermissions();initApp();
  }
  ['loginUsername','loginPassword'].forEach(function(id){document.getElementById(id).addEventListener('keydown',function(e){if(e.key==='Enter')handleLogin()})});
  document.getElementById('searchInput').addEventListener('keydown',function(e){if(e.key==='Enter')doSearch(1)});
  document.addEventListener('keydown',function(e){if(e.key==='Escape')closeModal()});
});
</script>
</body>
</html>

